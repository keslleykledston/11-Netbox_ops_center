services:
  proxy:
    image: nginx:latest
    container_name: netbox-ops-center-proxy
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
      - portainer
      - oxidized
      - redis
      - checkmk
    networks:
      - netbox-net
    restart: unless-stopped

  app:
    image: node:20-bullseye
    container_name: netbox-ops-center-app
    working_dir: /app
    environment:
      NODE_ENV: development
      DATABASE_URL: ${DATABASE_URL:-file:./dev.db}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      REDIS_URL: redis://redis:6379
      OXIDIZED_API_URL: http://oxidized:8888
      OXIDIZED_ROUTER_DB: /host-oxidized/router.db
      CHECKMK_URL: http://checkmk:5000/netbox
      CHECKMK_SITE: netbox
      CHECKMK_USERNAME: cmkadmin
      CHECKMK_PASSWORD: ${CHECKMK_PASSWORD:-admin}
    volumes:
      - .:/app
      - oxidized_config:/host-oxidized
      - ssh_sessions:/app/ssh-sessions
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Read-only access to Docker socket for logs
    command: >-
      sh -lc "
        apt-get update -qq && apt-get install -y -qq docker.io > /dev/null 2>&1 &&
        if [ ! -d node_modules ]; then npm install; fi &&
        if [ ! -d server/node_modules ]; then npm run server:install; fi &&
        npm run dev:stack
      "
    networks:
      - netbox-net
    restart: unless-stopped

  portainer:
    image: portainer/portainer-ce:latest
    container_name: netbox-ops-center-portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - netbox-net
    restart: unless-stopped

  oxidized:
    image: oxidized/oxidized:latest
    container_name: netbox-ops-center-oxidized
    ports:
      - "8888:8888" # Expose for debugging, but proxy handles it
    volumes:
      - oxidized_config:/home/oxidized/.config/oxidized
    environment:
      - CONFIG_RELOAD_INTERVAL=600
    networks:
      - netbox-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: netbox-ops-center-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - netbox-net
    restart: unless-stopped
    command: redis-server --appendonly yes

  checkmk:
    image: checkmk/check-mk-raw:latest
    container_name: netbox-ops-center-checkmk
    ports:
      - "8080:5000"
    volumes:
      - checkmk_data:/omd/sites
    environment:
      - CMK_SITE_ID=netbox
      - CMK_PASSWORD=${CHECKMK_PASSWORD:-admin}
    networks:
      - netbox-net
    restart: unless-stopped
    tmpfs:
      - /opt/omd/sites/netbox/tmp:uid=1000,gid=1000

volumes:
  portainer_data:
  oxidized_config:
  redis_data:
  checkmk_data:
  ssh_sessions:

networks:
  netbox-net:
    driver: bridge
