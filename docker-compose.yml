services:
  proxy:
    image: nginx:latest
    container_name: netbox-ops-center-proxy
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
      - portainer
      - oxidized
      - redis
      - librenms
      - grafana
      - hub-backend
    networks:
      - netbox-net
    restart: unless-stopped

  frontend:
    image: node:20-bullseye
    container_name: netbox-ops-center-frontend
    working_dir: /app
    environment:
      - API_SERVER_URL=http://backend:4000
      - VITE_HUB_API_URL=/hub-api
    volumes:
      - .:/app
    command: >-
      sh -lc "
        apt-get update -qq && apt-get install -y -qq git > /dev/null 2>&1 &&
        if [ ! -d node_modules ]; then npm install; fi &&
        npm run dev -- --host 0.0.0.0 --port 8080
      "
    expose:
      - "8080"
    networks:
      - netbox-net
    restart: unless-stopped

  backend:
    image: node:20-bullseye
    container_name: netbox-ops-center-backend
    working_dir: /app
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: ${DATABASE_URL:-postgresql://netbox_ops:netbox_ops@db:5432/netbox_ops}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      REDIS_URL: redis://redis:6379
      OXIDIZED_API_URL: http://oxidized:8888
      OXIDIZED_ROUTER_DB: /host-oxidized/router.db
      LIBRENMS_URL: http://librenms:8000
      LIBRENMS_API_TOKEN: ${LIBRENMS_API_TOKEN:-}
      AUTO_LIBRENMS_SYNC: ${AUTO_LIBRENMS_SYNC:-true}
      ENABLE_QUEUE_EVENTS: "true"
    volumes:
      - .:/app
      - oxidized_config:/host-oxidized
      - ssh_sessions:/app/ssh-sessions
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: >-
      sh -lc "
        if [ ! -d server/node_modules ]; then npm run server:install; fi &&
        npm --prefix server run prisma:generate &&
        migrate_ok=0;
        for i in 1 2 3 4 5 6 7 8 9 10; do
          npm --prefix server run db:migrate && migrate_ok=1 && break;
          echo \"[BOOT] Aguardando banco para migracoes ($${i}/10)...\" 1>&2;
          sleep 3;
        done;
        if [ \"$$migrate_ok\" -ne 1 ]; then
          echo \"[BOOT] Falha ao aplicar migracoes.\" 1>&2;
          exit 1;
        fi;
        npm --prefix server run start:api
      "
    expose:
      - "4000"
    depends_on:
      - db
      - redis
      - oxidized
    networks:
      - netbox-net
    restart: unless-stopped

  hub-backend:
    image: python:3.10-slim-bullseye
    container_name: netbox-ops-center-hub-backend
    working_dir: /app
    env_file:
      - .env
    environment:
      OXIDIZED_API_URL: http://oxidized:8888
      DATABASE_URL: ${DATABASE_URL:-postgresql://netbox_ops:netbox_ops@db:5432/netbox_ops}
    volumes:
      - ./backend:/app/backend
    command: >-
      sh -lc "
        pip install --no-cache-dir -r backend/requirements.txt && \
        PYTHONPATH=/app uvicorn backend.main:app --host 0.0.0.0 --port 8001
      "
    expose:
      - "8001"
    depends_on:
      - db
      - redis
    networks:
      - netbox-net
    restart: unless-stopped

  worker:
    image: node:20-bullseye
    container_name: netbox-ops-center-worker
    working_dir: /app
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://netbox_ops:netbox_ops@db:5432/netbox_ops}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      REDIS_URL: redis://redis:6379
      ENABLE_QUEUE_EVENTS: "false"
      SNMP_SERVER_URL: ${SNMP_SERVER_URL:-http://backend:3001}
    volumes:
      - .:/app
      - oxidized_config:/host-oxidized
      - ssh_sessions:/app/ssh-sessions
    command: >-
      sh -lc "
        if [ ! -d server/node_modules ]; then npm run server:install; fi &&
        npm --prefix server run prisma:generate &&
        migrate_ok=0;
        for i in 1 2 3 4 5 6 7 8 9 10; do
          npm --prefix server run db:migrate && migrate_ok=1 && break;
          echo \"[BOOT] Aguardando banco para migracoes ($${i}/10)...\" 1>&2;
          sleep 3;
        done;
        if [ \"$$migrate_ok\" -ne 1 ]; then
          echo \"[BOOT] Falha ao aplicar migracoes.\" 1>&2;
          exit 1;
        fi;
        npm --prefix server run start:worker
      "
    depends_on:
      - db
      - redis
    networks:
      - netbox-net
    restart: unless-stopped

  scheduler:
    image: node:20-bullseye
    container_name: netbox-ops-center-scheduler
    working_dir: /app
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://netbox_ops:netbox_ops@db:5432/netbox_ops}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      REDIS_URL: redis://redis:6379
      ENABLE_QUEUE_EVENTS: "false"
      SNMP_POLL_INTERVAL_MS: ${SNMP_POLL_INTERVAL_MS:-300000}
      OXIDIZED_SYNC_INTERVAL_MS: ${OXIDIZED_SYNC_INTERVAL_MS:-900000}
      AUTO_NETBOX_SYNC: ${AUTO_NETBOX_SYNC:-false}
      NETBOX_SYNC_INTERVAL_MS: ${NETBOX_SYNC_INTERVAL_MS:-1800000}
      LIBRENMS_URL: http://librenms:8000
      LIBRENMS_API_TOKEN: ${LIBRENMS_API_TOKEN:-}
      LIBRENMS_POLL_INTERVAL_MS: ${LIBRENMS_POLL_INTERVAL_MS:-300000}
      AUTO_LIBRENMS_POLL: ${AUTO_LIBRENMS_POLL:-true}
    volumes:
      - .:/app
      - oxidized_config:/host-oxidized
    command: >-
      sh -lc "
        if [ ! -d server/node_modules ]; then npm run server:install; fi &&
        npm --prefix server run prisma:generate &&
        migrate_ok=0;
        for i in 1 2 3 4 5 6 7 8 9 10; do
          npm --prefix server run db:migrate && migrate_ok=1 && break;
          echo \"[BOOT] Aguardando banco para migracoes ($${i}/10)...\" 1>&2;
          sleep 3;
        done;
        if [ \"$$migrate_ok\" -ne 1 ]; then
          echo \"[BOOT] Falha ao aplicar migracoes.\" 1>&2;
          exit 1;
        fi;
        npm --prefix server run start:scheduler
      "
    depends_on:
      - db
      - redis
    networks:
      - netbox-net
    restart: unless-stopped

  portainer:
    image: portainer/portainer-ce:latest
    container_name: netbox-ops-center-portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - netbox-net
    restart: unless-stopped

  oxidized:
    image: oxidized/oxidized:latest
    container_name: netbox-ops-center-oxidized
    ports:
      - "8888:8888"
    volumes:
      - oxidized_config:/home/oxidized/.config/oxidized
      - ./docker/oxidized-custom-models:/home/oxidized/.config/oxidized/model:ro
    environment:
      - CONFIG_RELOAD_INTERVAL=600
    networks:
      - netbox-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: netbox-ops-center-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - netbox-net
    restart: unless-stopped
    command: redis-server --appendonly yes

  db:
    image: postgres:16-alpine
    container_name: netbox-ops-center-db
    environment:
      POSTGRES_USER: netbox_ops
      POSTGRES_PASSWORD: netbox_ops
      POSTGRES_DB: netbox_ops
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - netbox-net
    restart: unless-stopped

  # CheckMK - DEPRECATED (substitu√≠do por LibreNMS)
  # checkmk:
  #   image: checkmk/check-mk-raw:latest
  #   container_name: netbox-ops-center-checkmk
  #   ports:
  #     - "8080:5000"
  #   volumes:
  #     - checkmk_data:/omd/sites
  #   environment:
  #     - CMK_SITE_ID=netbox
  #     - CMK_PASSWORD=${CHECKMK_PASSWORD:-admin}
  #   networks:
  #     - netbox-net
  #   restart: unless-stopped
  #   tmpfs:
  #     - /opt/omd/sites/netbox/tmp:uid=1000,gid=1000

  # LibreNMS - Network Monitoring System
  librenms:
    image: librenms/librenms:latest
    container_name: netbox-ops-center-librenms
    hostname: librenms
    cap_add:
      - NET_ADMIN
      - NET_RAW
    ports:
      - "8009:8000"
    environment:
      - TZ=America/Sao_Paulo
      - PUID=1000
      - PGID=1000
      - DB_HOST=librenms-db
      - DB_NAME=librenms
      - DB_USER=librenms
      - DB_PASSWORD=${LIBRENMS_DB_PASSWORD:-librenms_secure}
      - DB_TIMEOUT=60
      - LIBRENMS_SNMP_COMMUNITY=${LIBRENMS_SNMP_COMMUNITY:-public}
      - LIBRENMS_WEATHERMAP=false
      - LIBRENMS_SMOKEPING=false
      - BASE_URL=http://localhost:8009
    volumes:
      - librenms_data:/data
    depends_on:
      - librenms-db
      - librenms-redis
    networks:
      - netbox-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v0/system"]
      interval: 30s
      timeout: 10s
      retries: 3

  librenms-db:
    image: mariadb:10.11
    container_name: netbox-ops-center-librenms-db
    command:
      - "mysqld"
      - "--innodb-file-per-table=1"
      - "--lower-case-table-names=0"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
    environment:
      - TZ=America/Sao_Paulo
      - MYSQL_ROOT_PASSWORD=${LIBRENMS_DB_ROOT_PASSWORD:-librenms_root_secure}
      - MYSQL_DATABASE=librenms
      - MYSQL_USER=librenms
      - MYSQL_PASSWORD=${LIBRENMS_DB_PASSWORD:-librenms_secure}
    volumes:
      - librenms_db_data:/var/lib/mysql
    networks:
      - netbox-net
    restart: unless-stopped

  librenms-redis:
    image: redis:7-alpine
    container_name: netbox-ops-center-librenms-redis
    command: redis-server --appendonly yes
    volumes:
      - librenms_redis_data:/data
    networks:
      - netbox-net
    restart: unless-stopped

  # Grafana - Visualization & Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: netbox-ops-center-grafana
    ports:
      - "3033:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-worldmap-panel,grafana-piechart-panel,grafana-clock-panel
      - GF_SERVER_ROOT_URL=http://localhost:3033
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - netbox-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  portainer_data:
  oxidized_config:
  redis_data:
  # checkmk_data:  # DEPRECATED
  ssh_sessions:
  db_data:
  librenms_data:
  librenms_db_data:
  librenms_redis_data:
  grafana_data:

networks:
  netbox-net:
    driver: bridge
